"""Unit testing for poll.py"""

import pytest
from commands.rankdown_turn import rankdown_turn
from common.discord_ids import USERNAMES
from testing.interaction import (MockChannel, MockInteraction, MockMessage,
                                 MockUser)


@pytest.mark.asyncio()
@pytest.mark.parametrize([
    "elimination", "elimination_reason", "nomination", "nomination_reason", "next_message",
    "make_history", "expected_message", "followup_messages", "ephemeral"
    ], [
    ( # successful turn
        "CLC - Black Dress",
        "I just don't like it",
        "April - Lalalilala",
        "I'm blinded by its perfection",
        "_mic drop_",
        True,
        """<@904751089633615972>'s turn:

I eliminate **CLC - Black Dress**. I just don't like it

I nominate **April - Lalalilala**. I'm blinded by its perfection

**In Danger**
StayC - Beautiful Monster (stromsolar)
Purple Kiss - Sweet Juice (HallyU)
WJSN - Unnatural (kpopbrandy)
Girl's Day - I'll Be Yours (HallyU)
Shinee - Sherlock (Feldarak)
GWSN - Night Aviation (The Interpretation of Dreams) (Frozen Light, the Quiet Viking)
Dreamcatcher - Sleepwalking (stromsolar)
CSR - LOVETICON (Diana4Dragons)
AOA - Good Luck (Xion Rin)
April - Lalalilala (HallyU)

<@227092770110570496> _mic drop_""",
        [],
        False
    ),
    ( # successful turn - split up into 2
        "CLC - Black Dress",
        "123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890", # pylint: disable=line-too-long
        "April - Lalalilala",
        "I just don't like it",
        "_mic drop_",
        True,
         # pylint: disable=line-too-long
        """<@904751089633615972>'s turn:

I eliminate **CLC - Black Dress**. 123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890

I nominate **April - Lalalilala**. I just don't like it
""",
        ["""**In Danger**
StayC - Beautiful Monster (stromsolar)
Purple Kiss - Sweet Juice (HallyU)
WJSN - Unnatural (kpopbrandy)
Girl's Day - I'll Be Yours (HallyU)
Shinee - Sherlock (Feldarak)
GWSN - Night Aviation (The Interpretation of Dreams) (Frozen Light, the Quiet Viking)
Dreamcatcher - Sleepwalking (stromsolar)
CSR - LOVETICON (Diana4Dragons)
AOA - Good Luck (Xion Rin)
April - Lalalilala (HallyU)

<@227092770110570496> _mic drop_"""],
        False
    ),
    ( # successful turn - split up into 3
        "CLC - Black Dress",
        # pylint: disable=line-too-long
        "123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",
        "April - Lalalilala",
        # pylint: disable=line-too-long
        "12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",
        "_mic drop_",
        True,
        """<@904751089633615972>'s turn:

I eliminate **CLC - Black Dress**. 123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890
""",
        ["""I nominate **April - Lalalilala**. 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890
""",
"""**In Danger**
StayC - Beautiful Monster (stromsolar)
Purple Kiss - Sweet Juice (HallyU)
WJSN - Unnatural (kpopbrandy)
Girl's Day - I'll Be Yours (HallyU)
Shinee - Sherlock (Feldarak)
GWSN - Night Aviation (The Interpretation of Dreams) (Frozen Light, the Quiet Viking)
Dreamcatcher - Sleepwalking (stromsolar)
CSR - LOVETICON (Diana4Dragons)
AOA - Good Luck (Xion Rin)
April - Lalalilala (HallyU)

<@227092770110570496> _mic drop_"""],
        False
    ),
    ( # try to eliminate own nomination
        "Purple Kiss - Sweet Juice",
        "I just don't like it",
        "April - Lalalilala",
        "I'm blinded by its perfection",
        "_mic drop_",
        True,
        """You nominated "Purple Kiss - Sweet Juice", so you cannot eliminate it!""",
        [],
        True
    ),
    ( # try to eliminate non-existent song
        "woo!ah! - Rollercoaster",
        "I just don't like it",
        "April - Lalalilala",
        "I'm blinded by its perfection",
        "_mic drop_",
        True,
        # pylint: disable=line-too-long
        """"woo!ah! - Rollercoaster" was not found in the In Danger list! Make sure you copy the song exactly as it appears in the In Danger list.""",
        [],
        True
    ),
    ( # No previous message
        "woo!ah! - Rollercoaster",
        "I just don't like it",
        "April - Lalalilala",
        "I'm blinded by its perfection",
        "_mic drop_",
        False,
        "No previous turn was found! The command only supports turns after the first round.",
        [],
        True
    ),
    ( # Message too long (>2000 chars)
        "CLC - Black Dress",
        # pylint: disable=line-too-long
        "123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",
        "April - Lalalilala",
        "I'm blinded by its perfection",
        "_mic drop_",
        True,
        "Your reasoning is too long! The elimination and nomination reasons should each be less than 2,000 characters.",
        [],
        True
    )
])
# pylint: disable=too-many-arguments
async def test_rankdown_turn(elimination, elimination_reason, nomination, nomination_reason,
                             next_message, make_history, expected_message, followup_messages,
                             ephemeral):
    history = [
MockMessage("""@Xion Rin's turn:

I eliminate **Berry Good - Don't Believe**. Wow, I love the HallyU theme. But in all seriousness I do actually enjoy this song very much, but it is the lowest song I have on the In Danger list and cant bring myself to elimate anything else

I nominate **AOA - Good Luck**. AOA's music is the type of music that I don't actively search for it or go out of my way to listen to, but I won't complain if it comes on, and this song just fits that definition perfectly. Not something I'd look for but not upset if it comes on in a shuffle

**In Danger**
CLC - Black Dress (Diana4Dragons)
StayC - Beautiful Monster (stromsolar)
Purple Kiss - Sweet Juice (HallyU)
WJSN - Unnatural (kpopbrandy)
Girl's Day - I'll Be Yours (HallyU)
Shinee - Sherlock (Feldarak)
GWSN - Night Aviation (The Interpretation of Dreams) (Frozen Light, the Quiet Viking)
Dreamcatcher - Sleepwalking (stromsolar)
CSR - LOVETICON (Diana4Dragons)
AOA - Good Luck (Xion Rin)

@HallyU Good Luck to whatever you eliminate / save""")
        ] if make_history else []
    interaction = MockInteraction(
        MockUser(user_id=USERNAMES["HallyU"], name="soshi0805", nick="HallyU"),
        MockChannel("nomination-elimination", history=history))

    await rankdown_turn(interaction, elimination, elimination_reason, nomination, nomination_reason,
                        next_message)

    interaction.assert_message_equals(expected_message, ephemeral=ephemeral)

    if followup_messages:
        for msg in followup_messages:
            interaction.channel.assert_message_equals(msg)
